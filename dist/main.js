(()=>{var l=class{static create(t){return new this(t)}#t;#e;#i;#s;#r;#o;#n;#a;get path(){return this.#t}get ttl(){return this.#e}get hasTTL(){return this.#e!==null}get registry(){return this.#i}get origins(){return this.#s}get options(){return this.#r}get fieldLevelExpiry(){return!0}constructor({path:t,ttl:e=null,registry:s=new Map,origins:i=[],fireHook:r=null,serializeHook:n=null,deserializeHook:a=null,...o}={}){if(!Array.isArray(t))throw new Error("Path must be an array if provided");if(this.#t=t,e!==null&&typeof e!="number")throw new Error("TTL must be a number (in milliseconds) if provided; null otherwise");if(this.#e=e,!(s instanceof Map))throw new Error("Registry must be an instance of Map if provided");if(this.#i=s,!Array.isArray(i))throw new Error("Origins must be an array if provided");if(this.#s=i,this.#r=o,r&&typeof r!="function")throw new Error("fireHook must be a function if provided");if(this.#o=r,n&&typeof n!="function")throw new Error("serializeHook must be a function if provided");if(this.#n=n||((h,...c)=>h===void 0?null:JSON.stringify(h,...c)),a&&typeof a!="function")throw new Error("deserializeHook must be a function if provided");this.#a=a||(h=>h===null?void 0:JSON.parse(h))}_serialize(t,...e){return this.#n(t,...e)}_deserialize(t){return this.#a(t)}_path(t,e=!0){if(!Array.isArray(t))throw new Error("Path length cannot be 0");return t.reduce((s,i,r)=>{if(e&&!s?.subtree.has(i)){let n=new Map,a=new Set,o=()=>{s.subtree.delete(i),!s.subtree.size&&s.entries?.size};s.subtree.set(i,{subtree:n,entries:a,context:s,dispose:o})}return e===0&&!s?.subtree.has(i)?s:s?.subtree.get(i)},{subtree:this.#i,entries:new Set})}_subscribe(t,e,s={}){let i=this._path(t,!0),r=()=>{i.entries.delete(n),i.entries.size||i.dispose()},n={callback:e,options:s,origins:this.#s,dispose:r};return i.entries.add(n),s.signal&&s.signal.addEventListener("abort",r),r}async _fire({path:t=this.#t,origins:e=this.#s,timestamp:s=Date.now(),...i}){if(!["set","delete","clear","patch"].includes(i.type))throw new Error("Invalid event");let r=this._path(i.key?t.concat(i.key):t,0);if(!r)return;let n=[],a=r;do n.push(...a.entries);while((a=a.context)&&a.entries);let o=[],h=(c,f=i)=>{let{callback:u,options:d,origins:w,dispose:_}=c,m=e.length-1;for(;m>=(d.scope||0);m--)if(w[m]!==e[m])return;o.push(u({...f,path:t,scope:m+1,origins:e,timestamp:s})),d.once&&_()};if(n.forEach(c=>h(c)),i.type==="clear"||i.type==="patch"){let c=this._path(t,!1);for(let[f,u]of c?.subtree.entries()||[]){let d={type:"delete",key:f,detail:i.detail};if(i.type==="patch"&&i.data&&typeof i.data=="object"){if(f in i.data)d={type:"set",key:f,value:i.data[f],detail:i.detail};else if(!i.replace)continue}for(let w of u.entries)h(w,d)}}this.#o&&o.push(this.#o({path:t,origins:e,timestamp:s,...i})),await Promise.all(o)}_normalizeExpires(t){if(t??!1){if(t instanceof Date)return t.getTime();if(typeof t=="number")return t<1e12?t*1e3:t;if(typeof t=="string"){let e=Date.parse(t);if(!Number.isNaN(e))return e}throw new TypeError(`Invalid expires value: ${t}`)}}_expired(t){return!this.hasTTL||!this.fieldLevelExpiry?!1:!!(t?.expires&&t.expires<=Date.now())}_resolveSet(t,e,s){let i=typeof t=="object"&&t,r;({key:t,value:e,...r}=i?t:{key:t,value:e}),this.hasTTL&&this.fieldLevelExpiry&&(r.expires?r.expires=this._normalizeExpires(r.expires):r.expires=Date.now()+this.ttl);let n={type:"set",key:t,value:e,path:this.path,detail:s?.detail,origins:this.origins,timestamp:Date.now()};return{key:t,value:e,rest:r,event:n}}_resolveInputPatch(t,e){if(typeof t!="object")throw new Error("Argument must be a valid JSON object");let s=this.hasTTL&&this.fieldLevelExpiry?Date.now()+this.ttl:null,i={},r={};for(let[a,o]of Object.entries(t)){if(e.meta&&!(o&&typeof o=="object"))throw new Error(`A hash expected for field ${a}`);i[a]=e.meta?o.value:o,r[a]=e.meta?o:{value:o},s&&!r[a].expires?r[a].expires=s:this.hasTTL&&this.fieldLevelExpiry&&r[a].expires&&(r[a].expires=this._normalizeExpires(r[a].expires))}let n={type:"patch",data:i,meta:!!e?.meta,replace:!!e?.replace,detail:e?.detail,path:this.path,origins:this.origins,timestamp:Date.now()};return{data:r,event:n}}_resolveDelete(t,e){t=typeof t=="object"&&t?t.key:t;let s={type:"delete",key:t,path:this.path,detail:e?.detail,origins:this.origins,timestamp:Date.now()};return{key:t,event:s}}_resolveClear(t){return{event:{type:"clear",path:this.path,detail:t?.detail,origins:this.origins,timestamp:Date.now()}}}subscribe(t,e,s={}){typeof t=="function"&&(s=e||{},e=t,t=[]);let i=this.#t.concat(t);return this._subscribe(i,e,s)}cleanup(){this._path(this.#t,!1)?.dispose()}async close(){}};var b=class extends l{#t;#e;#i;#s;constructor({storage:t=null,channel:e=null,cookiePath:s="/",...i}={}){if(super(i),!t&&typeof cookieStore>"u")throw new Error("cookieStore is not available in this environment");this.#t=t||cookieStore,this.#e=this.path.join(":"),this.#s=s,e&&(this.#i=new BroadcastChannel(e))}#r(t){return`${this.#e}:${t}`}#o(t){return t?.startsWith(this.#e+":")}async#n(t,e=!0){if(typeof t=="string"&&(t=await this.#t.get(t)),!!t){if(this._expired(t)){await this.#t.delete(t.name,{path:this.#s}).catch(()=>{});return}return e&&(t.value=this._deserialize(t.value)),t}}async close(){this.#i?.close(),await super.close()}async count(){return(await this.keys()).length}async keys(){return(await this.#a()).map(([t])=>t)}async values(){return(await this.#a()).map(([,t])=>t)}async entries(){return await this.#a()}async json({meta:t=!1}={}){return Object.fromEntries(await this.#a({meta:t}))}async#a({meta:t=!1}={}){let e=await this.#t.getAll(),s=[];for(let i of e){if(!this.#o(i.name)||!(i=await this.#n(i)))continue;let r=i.name.slice(this.#e.length+1);delete i.name,s.push([r,t?i:i.value])}return s}async has(t){return t=typeof t=="object"&&t?t.key:t,!!await this.#n(this.#r(t),!1)}async get(t){let e=typeof t=="object"&&t;t=e?t.key:t;let s=await this.#n(this.#r(t));if(s)return delete s.name,e?s:s.value}async set(t,e,s={}){let i,r;({key:t,value:e,rest:i,event:r}=this._resolveSet(t,e,s)),await this.#t.set({path:this.#s,...i,name:this.#r(t),value:this._serialize(e)}),this.#i?.postMessage(r),await this._fire(r)}async patch(t=null,e={}){let{data:s,event:i}=this._resolveInputPatch(t,e);if(e.replace){let r=await this.#t.getAll();for(let n of r)this.#o(n.name)&&await this.#t.delete(n.name,{path:this.#s}).catch(()=>{})}for(let[r,{value:n,...a}]of Object.entries(s))await this.#t.set({path:this.#s,...a,name:this.#r(r),value:this._serialize(n)});this.#i?.postMessage(i),await this._fire(i)}async delete(t,e={}){let s;({key:t,event:s}=this._resolveDelete(t,e)),await this.#t.delete(this.#r(t),{path:this.#s}),this.#i?.postMessage(s),await this._fire(s)}async clear(t={}){let{event:e}=this._resolveClear(t),s=await this.#t.getAll();for(let i of s)this.#o(i.name)&&await this.#t.delete(i.name,{path:this.#s}).catch(()=>{});this.#i?.postMessage(e),await this._fire(e)}};var y=class p extends l{static#t=new Map;#e;#i;#s;#r;constructor({dbName:t="webqit_keyval",channel:e=null,...s}){super(s),this.#i=t,this.#s=this.path.join(":"),e&&(this.#r=new BroadcastChannel(e))}#o(t){t.onversionchange=()=>{t.close(),p.#t.delete(this.#i),this.#e=null}}async#n(){let t=this.#i;if(p.#t.has(t)&&(this.#e=p.#t.get(t),this.#e.objectStoreNames.contains(this.#s)))return this.#e;let e=async i=>new Promise((r,n)=>{let a=indexedDB.open(this.#i,i);a.onupgradeneeded=()=>{let o=a.result;o.objectStoreNames.contains(this.#s)||o.createObjectStore(this.#s)},a.onsuccess=()=>r(a.result),a.onerror=()=>n(a.error)}),s=await new Promise((i,r)=>{let n=indexedDB.open(this.#i);n.onsuccess=()=>i(n.result),n.onerror=()=>r(n.error)});if(s.objectStoreNames.contains(this.#s))this.#e=s;else{let i=s.version+1;s.close(),this.#e=await e(i)}return p.#t.set(t,this.#e),this.#o(this.#e),this.#e}#a(t="readonly"){return this.#e.transaction(this.#s,t).objectStore(this.#s)}async close(){this.#r?.close(),this.#e?.close(),p.#t.delete(this.#i),this.#e=null,await super.close()}async count(){return(await this.keys()).length}async keys(){return(await this.#h()).map(([t])=>t)}async values(){return(await this.#h()).map(([,t])=>t)}async entries(){return await this.#h()}async json({meta:t=!1}={}){return Object.fromEntries(await this.#h({meta:t}))}async#h({meta:t=!1}={}){return await this.#n(),new Promise((e,s)=>{let i=this.#e.transaction(this.#s,"readonly"),r=i.objectStore(this.#s),n=r.getAll(),a=r.getAllKeys(),o,h,c=[],f=[];n.onsuccess=()=>{o=n.result},a.onsuccess=()=>{h=a.result},i.oncomplete=()=>{if(h.forEach((u,d)=>{let w=o[d];this._expired(w)?f.push(u):c.push([u,t?w:w.value])}),f.length){let u=this.#e.transaction(this.#s,"readwrite"),d=u.objectStore(this.#s);f.forEach(w=>d.delete(w)),u.oncomplete=()=>e(c),u.onerror=()=>s(u.error)}else e(c)},i.onerror=()=>s(i.error)})}async has(t){return t=typeof t=="object"&&t?t.key:t,(await this.keys()).includes(t)}async get(t){let e=typeof t=="object"&&t;return t=e?t.key:t,await this.#n(),new Promise((s,i)=>{let r=this.#a().get(t);r.onsuccess=async()=>{let n=r.result;if(!n||this._expired(n))if(n){let a=this.#e.transaction(this.#s,"readwrite");a.objectStore(this.#s).delete(t),a.oncomplete=()=>s(),a.onerror=()=>i(a.error)}else s();else s(e?n:n.value)},r.onerror=()=>i(r.error)})}async set(t,e,s={}){let i,r;return{key:t,value:e,rest:i,event:r}=this._resolveSet(t,e,s),await this.#n(),new Promise((n,a)=>{let o=this.#e.transaction(this.#s,"readwrite");o.objectStore(this.#s).put({value:e,...i},t),o.oncomplete=async()=>{await this._fire(r),this.#r?.postMessage(r),n()},o.onerror=()=>a(o.error)})}async patch(t=null,e={}){let{data:s,event:i}=this._resolveInputPatch(t,e);return await this.#n(),new Promise((r,n)=>{let a=this.#e.transaction(this.#s,"readwrite"),o=a.objectStore(this.#s);e.replace&&o.clear();for(let[h,c]of Object.entries(s))o.put(c,h);a.oncomplete=async()=>{await this._fire(i),this.#r?.postMessage(i),r()},a.onerror=()=>n(a.error)})}async delete(t,e={}){let s;return{key:t,event:s}=this._resolveDelete(t,e),await this.#n(),new Promise((i,r)=>{let n=this.#e.transaction(this.#s,"readwrite");n.objectStore(this.#s).delete(t),n.oncomplete=async()=>{await this._fire(s),this.#r?.postMessage(s),i()},n.onerror=()=>r(n.error)})}async clear(t={}){let{event:e}=this._resolveClear(t);return await this.#n(),new Promise((s,i)=>{let r=this.#e.transaction(this.#s,"readwrite");r.objectStore(this.#s).clear(),r.oncomplete=async()=>{await this._fire(e),this.#r?.postMessage(e),s()},r.onerror=()=>i(r.error)})}};var g=class extends l{#t(t){if(!t?.subtree.has("value"))return;let e=t.subtree.get("expires");if(e&&e<=Date.now()){this.#e(t);return}return t}#e(t){t&&!t.entries.size?t.dispose():t?.subtree.clear()}async close(){}async count(){return(await this.keys()).length}async keys(){return(await this.#i()).map(([t])=>t)}async values(){return(await this.#i()).map(([,t])=>t)}async entries(){return await this.#i()}async json({meta:t=!1}={}){return Object.fromEntries(await this.#i({meta:t}))}async#i({meta:t=!1}={}){return[...this._path(this.path)?.subtree.entries()||[]].filter(([,e])=>this.#t(e)).map(([e,s])=>[e,t?Object.fromEntries(s.subtree):s.subtree.get("value")])}async has(t){t=typeof t=="object"&&t?t.key:t;let e=this.path.concat(t);return!!this.#t(this._path(e,!1))}async get(t){let e=typeof t=="object"&&t;t=e?t.key:t;let s=this.path.concat(t),i=this.#t(this._path(s,!1));if(i)return e?Object.fromEntries(i.subtree):i.subtree.get("value")}async set(t,e,s={}){let i,r;({key:t,value:e,rest:i,event:r}=this._resolveSet(t,e,s));let n=this.path.concat(t),a=this._path(n);a.subtree.set("value",e),Object.entries(i).forEach(([o,h])=>a.subtree.set(o,h)),await this._fire(r)}async patch(t=null,e={}){let{data:s,event:i}=this._resolveInputPatch(t,e);if(e.replace)for(let r of this._path(this.path,!1)?.subtree.values()||[])this.#e(r);for(let[r,n]of Object.entries(s)){let a=this.path.concat(r),o=this._path(a);Object.entries(n).forEach(([h,c])=>o.subtree.set(h,c))}await this._fire(i)}async delete(t,e={}){let s;({key:t,event:s}=this._resolveDelete(t,e));let i=this.path.concat(t),r=this._path(i,!1);this.#e(r),await this._fire(s)}async clear(t={}){let{event:e}=this._resolveClear(t);for(let s of this._path(this.path,!1)?.subtree.values()||[])this.#e(s);await this._fire(e)}};var v=class extends l{#t;#e;#i;constructor({storage:t="local",channel:e=null,...s}={}){super(s),this.#t=typeof t=="string"?t==="session"?window.sessionStorage:window.localStorage:t,this.#e=this.path.join(":"),e&&(this.#i=new BroadcastChannel(e))}#s(t){return`${this.#e}:${t}`}#r(t){return t?.startsWith(this.#e+":")}#o(t){let e=this.#s(t),s=this.#t.getItem(e);if(s==null)return;let i;try{i=this._deserialize(s)}catch{this.#t.removeItem(e);return}if(this._expired(i)){this.#t.removeItem(e);return}return i}#n(t,e){let s=this.#s(t);this.#t.setItem(s,this._serialize(e))}async close(){this.#i?.close(),await super.close()}async count(){return(await this.keys()).length}async keys(){return(await this.#a()).map(([t])=>t)}async values(){return(await this.#a()).map(([,t])=>t)}async entries(){return await this.#a()}async json({meta:t=!1}={}){return Object.fromEntries(await this.#a({meta:t}))}async#a({meta:t=!1}={}){let e=[];for(let s=0;s<this.#t.length;s++){let i=this.#t.key(s);if(!this.#r(i))continue;let r=i.slice(this.#e.length+1),n=this.#o(r);n&&e.push([r,t?n:n.value])}return e}async has(t){return t=typeof t=="object"&&t?t.key:t,!!this.#o(t)}async get(t){let e=typeof t=="object"&&t;t=e?t.key:t;let s=this.#o(t);if(s)return e?s:s.value}async set(t,e,s={}){let i,r;({key:t,value:e,rest:i,event:r}=this._resolveSet(t,e,s)),this.#n(t,{value:e,...i}),this.#i?.postMessage(r),await this._fire(r)}async patch(t=null,e={}){let{data:s,event:i}=this._resolveInputPatch(t,e);if(e.replace)for(let r=this.#t.length-1;r>=0;r--){let n=this.#t.key(r);this.#r(n)&&this.#t.removeItem(n)}for(let[r,n]of Object.entries(s)){let a={...n};this.#n(r,a)}this.#i?.postMessage(i),await this._fire(i)}async delete(t,e={}){let s;({key:t,event:s}=this._resolveDelete(t,e)),this.#t.removeItem(this.#s(t)),this.#i?.postMessage(s),await this._fire(s)}async clear(t={}){let{event:e}=this._resolveClear(t);for(let s=this.#t.length-1;s>=0;s--){let i=this.#t.key(s);this.#r(i)&&this.#t.removeItem(i)}this.#i?.postMessage(e),await this._fire(e)}};globalThis.webqit||(globalThis.webqit={});Object.assign(globalThis.webqit,{KV:l,CookieStoreKV:b,IndexedDBKV:y,InMemoryKV:g,WebStorageKV:v});})();
//# sourceMappingURL=main.js.map
