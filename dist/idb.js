(()=>{var u=class{static create(t){return new this(t)}#s;#t;#r;get path(){return this.#s}get registry(){return this.#t}get origins(){return this.#r}constructor({path:t,registry:r=new Map,origins:e=[]}={}){this.#s=t,this.#t=r,this.#r=e}_path(t,r=!0){if(!Array.isArray(t)||!t.length||t.length>this.#s.length+1)throw new Error(`Path length must be between 1 and ${this.#s.length+1}`);return t.reduce((e,s,i)=>{if(r===0&&i&&!e.subtree.has(s))return e;if(r&&!e.subtree.has(s)){let n=new Map,o=new Set,a=()=>e.subtree.delete(s);e.subtree.set(s,{subtree:n,entries:o,context:e,dispose:a})}return e?.subtree.get(s)},{subtree:this.#t})}_observe(t,r,e={}){let s=this._path(t,!0),i=()=>{s.entries.delete(n),s.entries.size||s.dispose()},n={callback:r,options:e,origins:this.#r,dispose:i};return s.entries.add(n),e.signal&&e.signal.addEventListener("abort",i),i}async _fire({path:t=this.#s,origins:r=this.#r,timestamp:e=Date.now(),...s}){if(!["set","delete","clear"].includes(s.type))throw new Error("Invalid event");let i=this._path(t,0);if(!i)return;let n=[],o=i;for(;o;)n.push(...o.entries),o=o.context;let a=[],f=(p,w=t)=>{let{callback:d,options:l,origins:m,dispose:b}=p,c=this.#r.length-1;for(;c>=(l.scope||0);c--)if(m[c]!==this.#r[c])return;a.push(d({...s,path:w,scope:c+1,origins:r,timestamp:e})),l.once&&b()};if(n.forEach(f),s.type==="clear"){let p=this._path(t,!1);for(let[w,d]of p?.subtree.entries()||[])for(let l of d.entries)f(l,t.concat(w))}await Promise.all(a)}observe(t,r,e={}){typeof t=="function"&&(e=r||{},r=t,t=[]);let s=this.#s.concat(t);return this._observe(s,r,e)}cleanup(){this._path(this.#s,!1)?.dispose()}};var g=class h extends u{static#s=new Map;#t;#r;#e;#a;#n;constructor({dbName:t="webqit",ttl:r=0,channel:e=null,...s}){super(s),this.#a=r,this.#r=t,this.#e=this.path.join(":"),e&&(this.#n=new BroadcastChannel(e))}#c(t){t.onversionchange=()=>{t.close(),h.#s.delete(this.#r),this.#t=null}}async#i(){let t=this.#r;if(h.#s.has(t)&&(this.#t=h.#s.get(t),this.#t.objectStoreNames.contains(this.#e)))return this.#t;let r=async s=>new Promise((i,n)=>{let o=indexedDB.open(this.#r,s);o.onupgradeneeded=()=>{let a=o.result;a.objectStoreNames.contains(this.#e)||a.createObjectStore(this.#e)},o.onsuccess=()=>i(o.result),o.onerror=()=>n(o.error)}),e=await new Promise((s,i)=>{let n=indexedDB.open(this.#r);n.onsuccess=()=>s(n.result),n.onerror=()=>i(n.error)});if(e.objectStoreNames.contains(this.#e))this.#t=e;else{let s=e.version+1;e.close(),this.#t=await r(s)}return h.#s.set(t,this.#t),this.#c(this.#t),this.#t}#o(t="readonly"){return this.#t.transaction(this.#e,t).objectStore(this.#e)}#h(t){return t?.expiresAt&&t.expiresAt<=Date.now()}#l(t){return{value:t,expiresAt:this.#a?Date.now()+this.#a*1e3:null}}async close(){this.#n?.close(),this.#t?.close()}async has(t){return await this.get(t)!==void 0}async get(t){return await this.#i(),new Promise((r,e)=>{let s=this.#o().get(t);s.onsuccess=async()=>{let i=s.result;!i||this.#h(i)?(i&&await this.delete(t),r(void 0)):r(i.value)},s.onerror=()=>e(s.error)})}async set(t,r){await this.#i();let e={type:"set",key:t,value:r,path:this.path,origins:this.origins,timestamp:Date.now()};return new Promise((s,i)=>{let n=this.#t.transaction(this.#e,"readwrite");n.objectStore(this.#e).put(this.#l(r),t),n.oncomplete=async()=>{await this._fire(e),this.#n?.postMessage(e),s()},n.onerror=()=>i(n.error)})}async delete(t){await this.#i();let r={type:"delete",key:t,path:this.path,origins:this.origins,timestamp:Date.now()};return new Promise((e,s)=>{let i=this.#t.transaction(this.#e,"readwrite");i.objectStore(this.#e).delete(t),i.oncomplete=async()=>{await this._fire(r),this.#n?.postMessage(r),e()},i.onerror=()=>s(i.error)})}async clear(){await this.#i();let t={type:"clear",path:this.path,origins:this.origins,timestamp:Date.now()};return new Promise((r,e)=>{let s=this.#t.transaction(this.#e,"readwrite");s.objectStore(this.#e).clear(),s.oncomplete=async()=>{await this._fire(t),this.#n?.postMessage(t),r()},s.onerror=()=>e(s.error)})}async keys(){return await this.#i(),new Promise((t,r)=>{let e=this.#o().getAllKeys();e.onsuccess=()=>t(e.result),e.onerror=()=>r(e.error)})}async values(){return await this.#i(),new Promise((t,r)=>{let e=this.#o().getAll();e.onsuccess=()=>{t(e.result.filter(s=>!this.#h(s)).map(s=>s.value))},e.onerror=()=>r(e.error)})}async entries(){return await this.#i(),new Promise((t,r)=>{let e=this.#o().getAll(),s=this.#o().getAllKeys();Promise.all([new Promise(i=>e.onsuccess=()=>i(e.result)),new Promise(i=>s.onsuccess=()=>i(s.result))]).then(([i,n])=>{t(n.map((o,a)=>[o,i[a]]).filter(([,o])=>!this.#h(o)).map(([o,a])=>[o,a.value]))}).catch(r)})}async count(){return(await this.entries()).length}};})();
//# sourceMappingURL=idb.js.map
